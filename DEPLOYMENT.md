# DevApply Backend - Deployment Guide

This guide covers deploying the DevApply backend to Render using Docker.

## Prerequisites

- GitHub account (for code hosting)
- Render account (free tier works)
- Gmail account with App Password (for SMTP)
- Generated encryption key (using `generate_key.py`)

## Quick Deployment to Render

### Step 1: Prepare Your Repository

1. **Generate Encryption Key**
   ```bash
   python3 generate_key.py
   ```
   Copy the generated key (format: `yw1N4c0Gg0DH0bF-U5Le_khoqkKDLNqsK7EkkqhuSlw=`)

2. **Push to GitHub**
   ```bash
   git add .
   git commit -m "Ready for deployment"
   git push origin main
   ```

### Step 2: Deploy to Render

**Option A: Using render.yaml (Automatic - Recommended)**

1. Go to [Render Dashboard](https://dashboard.render.com/)
2. Click "New" → "Blueprint"
3. Connect your GitHub repository
4. Select the repository with `render.yaml`
5. Render will create all services automatically:
   - `devapply-db` - PostgreSQL database
   - `devapply-redis` - Redis instance
   - `devapply-api` - Flask web server
   - `devapply-worker` - Celery worker
   - `devapply-beat` - Celery beat scheduler

6. Set environment variables (click on each service):

   **For devapply-api:**
   - `CREDENTIALS_ENCRYPTION_KEY`: `<your-generated-key>`
   - `SMTP_USER`: `your-email@gmail.com`
   - `SMTP_PASS`: `<your-gmail-app-password>`

   **For devapply-worker:**
   - `CREDENTIALS_ENCRYPTION_KEY`: `<your-generated-key>`
   - `SMTP_USER`: `your-email@gmail.com`
   - `SMTP_PASS`: `<your-gmail-app-password>`

   **For devapply-beat:**
   - `CREDENTIALS_ENCRYPTION_KEY`: `<your-generated-key>`

7. Save and deploy!

**Option B: Manual Setup**

1. **Create PostgreSQL Database**
   - Click "New" → "PostgreSQL"
   - Name: `devapply-db`
   - Plan: Free
   - Create Database

2. **Create Redis Instance**
   - Click "New" → "Redis"
   - Name: `devapply-redis`
   - Plan: Free
   - Create Redis

3. **Create Web Service (Flask API)**
   - Click "New" → "Web Service"
   - Connect GitHub repository
   - Environment: Docker
   - Name: `devapply-api`
   - Region: Oregon (or your choice)
   - Branch: `main`
   - Docker Command: `sh scripts/start-web.sh`
   - Plan: Free

   Environment Variables:
   ```
   DATABASE_URL=<from-postgres-service>
   REDIS_URL=<from-redis-service>
   CELERY_BROKER_URL=<from-redis-service>
   CELERY_RESULT_BACKEND=<from-redis-service>
   FLASK_APP=run.py
   FLASK_ENV=production
   JWT_SECRET_KEY=<auto-generated>
   CREDENTIALS_ENCRYPTION_KEY=<your-key>
   SMTP_HOST=smtp.gmail.com
   SMTP_PORT=587
   SMTP_USER=<your-email>
   SMTP_PASS=<your-app-password>
   SMTP_FROM=noreply@devapply.com
   MAX_APPLICATIONS_PER_HOUR=5
   MAX_APPLICATIONS_PER_DAY=20
   ```

4. **Create Background Worker**
   - Click "New" → "Background Worker"
   - Connect same repository
   - Environment: Docker
   - Name: `devapply-worker`
   - Docker Command: `sh scripts/start-worker.sh`
   - Add same environment variables as web service

5. **Create Beat Scheduler**
   - Click "New" → "Background Worker"
   - Name: `devapply-beat`
   - Docker Command: `sh scripts/start-beat.sh`
   - Add environment variables (needs DATABASE_URL, REDIS_URL, CREDENTIALS_ENCRYPTION_KEY)

### Step 3: Get Gmail App Password

1. Go to [Google Account Security](https://myaccount.google.com/security)
2. Enable 2-Step Verification (if not already enabled)
3. Go to "App passwords"
4. Generate new app password for "Mail"
5. Copy the 16-character password
6. Use this as `SMTP_PASS` in Render

### Step 4: Verify Deployment

1. **Check Web Service Logs**
   ```
   Starting DevApply Web Server...
   Database is ready!
   Running database migrations...
   Seeding platforms...
   Starting Gunicorn server...
   ```

2. **Check Worker Logs**
   ```
   Starting DevApply Celery Worker...
   Redis is ready!
   Starting Celery worker...
   celery@worker ready.
   ```

3. **Check Beat Logs**
   ```
   Starting DevApply Celery Beat Scheduler...
   Redis is ready!
   Starting Celery beat scheduler...
   beat: Starting...
   ```

4. **Test API Health**
   ```bash
   curl https://your-app.onrender.com/health
   ```
   Should return:
   ```json
   {
     "status": "healthy",
     "timestamp": "2025-11-15T07:21:14Z"
   }
   ```

5. **Test User Registration**
   ```bash
   curl -X POST https://your-app.onrender.com/api/auth/register \
     -H "Content-Type: application/json" \
     -d '{
       "email": "test@example.com",
       "password": "TestPassword123!",
       "full_name": "Test User"
     }'
   ```

## Environment Variables Reference

### Required

| Variable | Description | Example |
|----------|-------------|---------|
| `DATABASE_URL` | PostgreSQL connection string | `postgresql://user:pass@host/db` |
| `REDIS_URL` | Redis connection string | `redis://host:6379/0` |
| `CELERY_BROKER_URL` | Celery broker (usually same as Redis) | `redis://host:6379/0` |
| `CELERY_RESULT_BACKEND` | Celery results backend | `redis://host:6379/0` |
| `JWT_SECRET_KEY` | Secret for JWT tokens | Auto-generated or custom |
| `CREDENTIALS_ENCRYPTION_KEY` | Fernet encryption key | From `generate_key.py` |

### Optional (Email)

| Variable | Description | Default |
|----------|-------------|---------|
| `SMTP_HOST` | SMTP server host | `smtp.gmail.com` |
| `SMTP_PORT` | SMTP server port | `587` |
| `SMTP_USER` | SMTP username | - |
| `SMTP_PASS` | SMTP password | - |
| `SMTP_FROM` | From email address | `noreply@devapply.com` |

### Optional (Application)

| Variable | Description | Default |
|----------|-------------|---------|
| `FLASK_ENV` | Environment | `production` |
| `MAX_APPLICATIONS_PER_HOUR` | Rate limit per hour | `5` |
| `MAX_APPLICATIONS_PER_DAY` | Rate limit per day | `20` |
| `APPLICATION_DELAY_SECONDS` | Delay between applications | `180` |
| `WEB_WORKERS` | Gunicorn workers | `4` |
| `CELERY_CONCURRENCY` | Celery worker processes | `2` |

## Troubleshooting

### Service Won't Start

**Check Logs:**
1. Go to Render dashboard
2. Click on the service
3. Click "Logs" tab
4. Look for error messages

**Common Issues:**
- Missing environment variables
- Database connection failed
- Redis connection failed
- Chrome/ChromeDriver not found in container

### Database Migration Errors

```bash
# Manually run migrations from Render shell
flask db upgrade
flask seed_platforms
```

### Celery Not Processing Tasks

1. Check worker logs for errors
2. Verify Redis connection
3. Check beat scheduler is running
4. Manually trigger task:
   ```python
   from app.tasks.job_scraper import scrape_jobs_all_users
   scrape_jobs_all_users.delay()
   ```

### Email Not Sending

1. Verify SMTP credentials
2. Check Gmail App Password is correct
3. Ensure 2FA is enabled on Gmail
4. Check email service logs

### Chrome/Selenium Issues

```bash
# Check Chrome version in container
google-chrome --version

# Check ChromeDriver
chromedriver --version
```

## Monitoring

### Render Dashboard
- View real-time logs
- Monitor resource usage
- Check service health

### API Health Endpoint
```bash
curl https://your-app.onrender.com/health
```

### Celery Flower (Optional)
Deploy Flower as separate service to monitor tasks:
```bash
# Add to render.yaml or create manually
celery -A celery_worker.celery flower --port=5555
```

## Scaling

### Render Free Tier Limitations
- Services spin down after 15 minutes of inactivity
- Limited CPU and memory
- Shared database storage

### Upgrade Options
- **Starter Plan** ($7/month per service)
  - No spin down
  - More resources
  - Better performance

- **Standard Plan** ($25/month per service)
  - Dedicated resources
  - Auto-scaling
  - Priority support

## Security Checklist

- [ ] Generated strong JWT secret
- [ ] Generated strong encryption key
- [ ] Using Gmail App Password (not real password)
- [ ] Environment variables are set correctly
- [ ] Database has strong password
- [ ] CORS origins configured for production frontend
- [ ] Rate limiting enabled
- [ ] HTTPS enabled (automatic on Render)

## Backup Strategy

### Database Backups (Render)
- Free tier: 7-day point-in-time recovery
- Paid tier: Automated daily backups

### Manual Backup
```bash
# Export database
pg_dump $DATABASE_URL > backup.sql

# Restore database
psql $DATABASE_URL < backup.sql
```

## Next Steps

After successful deployment:

1. **Update Frontend Config**
   - Set API base URL to Render web service URL
   - Configure CORS if needed

2. **Test All Features**
   - User registration
   - Login
   - Resume upload
   - Job search configuration
   - Platform credentials
   - Automation queue

3. **Monitor Performance**
   - Check response times
   - Monitor error rates
   - Review automation logs

4. **Set Up Alerts**
   - Render provides email alerts
   - Configure Slack/Discord webhooks

## Support

- **Render Docs**: https://render.com/docs
- **DevApply Issues**: Create issue in GitHub repository
- **Email**: support@devapply.com
